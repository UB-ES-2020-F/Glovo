services:
  - docker
language: csharp
mono: none
dotnet: 3.1
addons:
 sonarqube: true
solution: server/glovo_webapi/glovo_webapi.sln
install:
  - dotnet tool install --global dotnet-ef
  - export PATH="$HOME/.dotnet/tools":$PATH
  - git clone https://github.com/flutter/flutter.git -b beta
  - export PATH="$TRAVIS_BUILD_DIR/flutter/bin:$PATH"
  - flutter config --enable-web
  - dotnet tool install --global dotnet-sonarscanner --version 4.8.0

stages:
  - tests
  - code_ana
  - name: deploy
    if: branch = main

addons:
  sonarcloud:
    organization: "1komettest"
    token:
      secure: "uvZiACdrs4yDCWgXwCM5qlcRUgj/2926ZBhr+LMxhSp+LGDbcdVCjCrbDoCVPmXbUzIS4bpNuva6gbX8X01ISY858ATKtO9Qt+h0L/hSGSpMWdbRqI1SOLoFthKPVd01LfqLpejqqp3q7ZZ/wDvRnQ+qke7Y2cXXCAYrNgn2YBFYIYeOFdu29+03Lnbt4VLY1aDpUXwdlb9127D+KexfGV0jrLJs8Kg+o7E87GlH6ZsZo8lBOZz6Vhhcs7AZNjKiZYQUr5nw1nMEETHiST7CNDZXi/bl/RCOUDSlJbVrt8mglPRohTxNHSWaFxqeU/UkQHbHEpzzmZuUgUvR9olxqnSWgGhgD8EJOfBbk5JWlReT6JGS5PsDhQV8YF5peAkSrw7YALLEcItD2w2wU1yocK22BUvci4PfFx05wtbQcWas5ztEsHTD88x6YvWVcX9fkc73kgapUUpAcVJtJ55yv3QQS4nUKdTbdMzaUeYHd0CL/KaypS0iwhEswfl6aOlcIeccaP9uWvP6FAdS5qujcVg8U8RE7fxanIXZxQQMd9RMUISpYglDEBJUAmCqzyUZOtLS/BMyMkOvCkOj/oB+VLL4rvvimvHSE5ORiUGpLzKDruCInCYBRl9yH8Cl3eg2S11yD+BqqpQX0N9Vh6VbjmZdJcqqNjffuihfwdQljKA="


jobs:
  include:
    - stage: tests
      name: "Unit Tests"
      script:
        - echo "PASS"
    - name: "Integration Tests"
      script:
        - echo "PASS"
        - cd $TRAVIS_BUILD_DIR/server/glovo_webapi
        - dotnet restore
        - cd glovo_webapi
        - dotnet build --no-incremental
        - dotnet publish -c Release -o publish
        - cd $TRAVIS_BUILD_DIR/server/docker_database
        - bash load_server_travis.sh
        - cd $TRAVIS_BUILD_DIR/server/glovo_webapi/glovo_webapi/publish
        - ASPNETCORE_ENVIRONMENT=Development
        - dotnet glovo_webapi.dll &
        - cd $TRAVIS_BUILD_DIR/frontend/customerapp
        - flutter test test_driver/tests/endpoints/orders.dart
    - stage: code_ana
      script: 
        - cd $TRAVIS_BUILD_DIR/server/glovo_webapi
        - dotnet sonarscanner begin /k:"komet-backend" /d:sonar.login=22f8d2eca713452d014065d4a3bfa6884ec28d17 /d:sonar.host.url=http://167.71.130.118:9000
        - dotnet build glovo_webapi.sln
        - dotnet sonarscanner end  /d:sonar.login=22f8d2eca713452d014065d4a3bfa6884ec28d17 
    - stage: deploy
      name: "Backend"
      script:
        - cd $TRAVIS_BUILD_DIR/server/glovo_webapi
        - dotnet restore
        - cd glovo_webapi
        - dotnet publish -c Release -o $TRAVIS_BUILD_DIR/backend_deployment/publish
        - cd $TRAVIS_BUILD_DIR/backend_deployment
        - dotnet ef migrations script --idempotent --project $TRAVIS_BUILD_DIR/server/glovo_webapi/glovo_webapi -o migration.sql
        - heroku pg:psql --app ub-es2020-glovo-webapi < migration.sql
        - heroku container:login
        - heroku container:push web -a ub-es2020-glovo-webapi
        - heroku container:release web -a ub-es2020-glovo-webapi
    - name: "Frontend"
      script:
        - echo "machine git.heroku.com login eudald.elias@gmail.com password 49916134-f0ec-4564-a22d-c40da16b9872" > $HOME/.netrc
        - cd $TRAVIS_BUILD_DIR/frontend/customerapp
        - flutter build web
        - ls -R build/web/
        - cp -r build/web $TRAVIS_BUILD_DIR/frontend_deploy/web
        - cd $TRAVIS_BUILD_DIR/frontend_deploy
        - git init
        - heroku git:remote -a ub-es2020-glovo
        - git add .
        - git commit -am "deploy"
        - git push -f heroku master
    
      
