services:
- docker
language: csharp
mono: none
dotnet: 3.1
addons:
  sonarqube: true
solution: server/glovo_webapi/glovo_webapi.sln
install:
- dotnet tool install --global dotnet-ef
- export PATH="$HOME/.dotnet/tools":$PATH
- git clone https://github.com/flutter/flutter.git -b beta
- export PATH="$TRAVIS_BUILD_DIR/flutter/bin:$PATH"
- flutter config --enable-web
- dotnet tool install --global dotnet-sonarscanner
stages:
- tests
- code_ana
- name: deploy
  if: branch = main
jobs:
  include:
  - stage: tests
    name: Unit Tests
    script:
    - echo "PASS"
  - name: Integration Tests
    script:
    - echo "PASS"
    - cd $TRAVIS_BUILD_DIR/server/glovo_webapi
    - dotnet restore
    - cd glovo_webapi
    - dotnet build --no-incremental
    - dotnet publish -c Release -o publish
    - cd $TRAVIS_BUILD_DIR/server/docker_database
    - bash load_server_travis.sh
    - cd $TRAVIS_BUILD_DIR/server/glovo_webapi/glovo_webapi/publish
    - ASPNETCORE_ENVIRONMENT=Development
    - dotnet glovo_webapi.dll &
    - cd $TRAVIS_BUILD_DIR/frontend/customerapp
    - flutter test test_driver/tests/endpoints/orders.dart
  - stage: code_ana
    script:
    - cd $TRAVIS_BUILD_DIR/server/glovo_webapi
    - dotnet sonarscanner begin /k:"komet_backend" /d:sonar.login=$SONARVAR
      /d:sonar.host.url=http://167.71.130.118:9000 /d:sonar.verbose=true
    - dotnet build glovo_webapi.sln
    - which dotnet
    - dotnet sonarscanner end /d:sonar.login=$SONARVAR
  - stage: deploy
    name: Backend
    script:
    - cd $TRAVIS_BUILD_DIR/server/glovo_webapi
    - dotnet restore
    - cd glovo_webapi
    - dotnet publish -c Release -o $TRAVIS_BUILD_DIR/backend_deployment/publish
    - cd $TRAVIS_BUILD_DIR/backend_deployment
    - dotnet ef migrations script --idempotent --project $TRAVIS_BUILD_DIR/server/glovo_webapi/glovo_webapi
      -o migration.sql
    - heroku pg:psql --app ub-es2020-glovo-webapi < migration.sql
    - heroku container:login
    - heroku container:push web -a ub-es2020-glovo-webapi
    - heroku container:release web -a ub-es2020-glovo-webapi
  - name: Frontend
    script:
    - echo "machine git.heroku.com login eudald.elias@gmail.com password 49916134-f0ec-4564-a22d-c40da16b9872"
    - cd $TRAVIS_BUILD_DIR/frontend/customerapp
    - flutter build web
    - ls -R build/web/
    - cp -r build/web $TRAVIS_BUILD_DIR/frontend_deploy/web
    - cd $TRAVIS_BUILD_DIR/frontend_deploy
    - git init
    - heroku git:remote -a ub-es2020-glovo
    - git add .
    - git commit -am "deploy"
    - git push -f heroku master
env:
  global:
  - secure: 3rm1M/ndMhy3UZh6xLYgOvwm94Au9w5hrCOXWkFZ/yRwAcCWVTwA3xTEOSZXQvRELwyYTyX+6DfPghregd2aPP9DX6LV02Be64YxkgWYzoUPpnXdLkzlUe6GQgUkHEyDnPQe2dcSLzE14dvb9+BUm+SiGVXqEEqGC9S+yqSadVbUIN60/fzJNQvbo8hVz2TrmL2eqK5PaD0xFSMwgIUxGctxeo4kJT0ZY8u5xSxMG7X+yoFDGiHoDuv/20neunY7vQ8+EzrrV5gpqB75hG9KA/DMyATvpLM2SgHgVrr8qxoU2OmQl2HczorPv8vGGAny8SE33cZSDq35LiFDwvRc3kpQWa2WOta8l8/NTmbp6Z8EMFP1ox2UnPpS9OGlkkzPeNB3YqAlTD80NR5mc3dRcQNRm2KzKHRTrLNtxcynFkqx67e8v1aJ295qHLD6SW22wTvt79Ima2s6sfnawdBojUC2UaQIhtPeaXDwwQ8pJVGyUtVceFaXyDxfgKQhRItuZcrp92XNU4CoDatN4JGxcTb+yRlQa+yIV4XiXgSNAIIfaQXY/58do7GXFNZnwQYQH1o/6Hm7VCDnd3Eo73MUozw5TB++3Am9WrcF519QR8z0hvWi/kjhD3EczO8fPdqbY5C23oC6HV2EmKOnLYMgbnH+tDZwzPk65IItad0WwmE=
  - secure: y79gg1ZXcWf6+AylKZIyR/5hNRmFUFTV9zpGpHF/8EAn7pjxb6gxr8RjoD0EJb4GD3agoRab3hoIkVgpi3vt1uSNQ2WtNFBpMUC583u8Msa5uIrxNhgSo0gJs2ZXmhH4SyXf/Ot6z9v/e1VpkqeCd6t3Ljpl44NG7u3Z3btKuHv+moyKT4cu7XAAWLVcSS5j5SqNIt6AE4qAOu5Ro01A8vLnpMh83V/vs/EIn2F0qIJ5zflxZH2laQrJWQrL+/LQVrQprKuCIasRSd8WCAUmEzF1DFAFigkNjfTPmbaXgmuTpNiehDnngO0FnbNzGvgeRl98mYKfW4FuRrW+TdvymN2melniStn1po/HdGc3W6evNIcapNkO3P6E1t9lgXC7tSxHy1FGmARlJXUZX4qMQF/+Vfx3UgyVY+t9pof+vmkob4Cmdo5pny2slWvJjJJd/gjmbNDXfSUec68Cvc2mHseMiFbeqOTVgbr9aU7q/H7IUICGQZF55XDphOMfoECeB5VxWr4jWNjvUJr49VfymGB9yVWlWfxW9hI8jHpZeNhjkvRCL27afzLanqUpTqhm59GnQjcJNzVoz630OCAPvmB1X3n08AWxR6DkIxfjYMpaY+qzQXfY030gNnvJHhDl84dThONOUttkIOA3eeXFUMeNqG2DFr7wJvnveNMpxzk=
